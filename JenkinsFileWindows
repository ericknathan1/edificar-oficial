pipeline {
    agent any
    stages {
        stage('Verificar Repositório') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], useRemoteConfigs: [[url: 'https://github.com/ericknathan1/edificar-oficial.git']]])
            }
        }

        stage('Instalar Dependências') {
            steps {
                script {
                    env.PATH = "/usr/bin:$PATH"

                     dir('backend') {
                        bat 'mvn clean install'
                     }

                }
            }
        }


        stage('Construir Imagem Docker (Backend + APK)') {
            steps {
                script {
                    withEnv(['DOCKER_HOST=npipe:////./pipe/docker_engine']) { // Adicionado para forçar a conexão
                        def appName = 'edificar'
                        def imageTag = "${appName}:${env.BUILD_ID}"
                        def dockerFilePath = 'backend/Dockerfile'
                        def frontendArtifactImageTag = "apk-artifact-temp:${env.BUILD_ID}"
                        
                        // 1. Constrói a Imagem Principal do Backend 
                        bat "docker build -f ${dockerFilePath} -t ${imageTag} --target backend-runtime ."
                        echo 'Imagem Docker do Backend construída.'
                        
                        // 2. Constrói a Imagem de Artefato (APK)
                        bat "docker build -f ${dockerFilePath} -t ${frontendArtifactImageTag} --target apk-artifact ."
                        
                        // ... (Lógica de extração e limpeza) ...
                        
                        def containerId = bat(
                            script: "docker create ${frontendArtifactImageTag}", 
                            returnStdout: true
                        ).trim()
                        echo "Container temporário criado para APK: ${containerId}"

                        bat "docker cp ${containerId}:/app/edificar-app-release.apk frontend/app-release-${env.BUILD_ID}.apk"
                        echo "APK de Release copiado para: frontend/app-release-${env.BUILD_ID}.apk"
                        
                        bat "docker rm ${containerId}"
                        bat "docker rmi ${frontendArtifactImageTag}"
                    }
                }
            }
        }
        stage('Fazer Deploy') {
            steps {
                script {
                    def appName = 'edificar'
                    def imageTag = "${appName}:${env.BUILD_ID}"

                    // Para e remove container existente, se houver
                    bat "docker stop ${appName} || exit 0"
                    bat "docker rm -v ${appName} || exit 0"

                    // Executar o novo container
                    bat "docker run -d --name ${appName} -p 8417:8417 ${imageTag}"

                }
            }
        }
    }

    post {
        success {
            echo 'Deploy realizado com sucesso!'
        }
        failure {
            echo 'Houve um erro durante o deploy.'
        }
    }
}